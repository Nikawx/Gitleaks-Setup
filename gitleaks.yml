trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  reportDir: '$(System.DefaultWorkingDirectory)/gitleaks-reports'
  summaryFile: '$(Build.ArtifactStagingDirectory)/gitleaks-summary.md'
  artifactHtmlDir: '$(Build.ArtifactStagingDirectory)/gitleaks-html'

jobs:
  - job: GitleaksScan
    displayName: Run Gitleaks scan
    steps:
      - checkout: self

      - script: |
          echo "ğŸ“¥ TÃ©lÃ©chargement de Gitleaks..."
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "DerniÃ¨re version: $GITLEAKS_VERSION"

          curl -LO https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz
          tar -xzf gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          gitleaks version
        displayName: "ğŸ“¦ Installer Gitleaks"

      - script: |
          echo "ğŸ” Lancement du scan Gitleaks (JSON)"
          mkdir -p $(reportDir)
          gitleaks detect --source . --report-format=json --report-path=$(reportDir)/gitleaks.json || echo "ğŸš¨ Secrets dÃ©tectÃ©s (mais le pipeline continue)."
        displayName: "ğŸš¨ ExÃ©cuter Gitleaks (JSON)"

      - script: |
          echo "ğŸ“ GÃ©nÃ©ration du rÃ©sumÃ© Markdown (top 20)"
          echo "## RÃ©sumÃ© Gitleaks" > $(summaryFile)
          echo "" >> $(summaryFile)

          echo "### ğŸ“‚ Rapport HTML disponible en artefact **Gitleaks-HTML-Reports**" >> $(summaryFile)
          echo "" >> $(summaryFile)

          echo "### ğŸ” Secrets dÃ©tectÃ©s (Top 20)" >> $(summaryFile)
          jq -r '
            if (. | length) == 0 then
              "Aucun secret dÃ©tectÃ©."
            else
              .[:20][] | 
              "- **Fichier :** " + .File + ", **Ligne :** " + (.StartLine|tostring) + ", **RÃ¨gle :** " + .RuleID + ", **Secret :** `" + (.Secret // "non affichÃ©") + "`"
            end' $(reportDir)/gitleaks.json >> $(summaryFile)
          echo "" >> $(summaryFile)
        displayName: "ğŸ“ GÃ©nÃ©rer rÃ©sumÃ© Markdown"

      - script: |
          echo "ğŸ› ï¸ GÃ©nÃ©ration du rapport HTML simplifiÃ© (top 100)"
          mkdir -p $(artifactHtmlDir)
          echo "<html><head><meta charset='UTF-8'><title>Rapport Gitleaks</title></head><body><h1>Secrets dÃ©tectÃ©s</h1><p><em>(Top 100)</em></p><ul>" > $(artifactHtmlDir)/gitleaks.html
          jq -r '
            .[:100][] | 
            "<li><strong>" + .RuleID + "</strong> dans <code>" + .File + "</code> (ligne " + (.StartLine|tostring) + ") : <code>" + (.Secret // "non affichÃ©") + "</code></li>"
          ' $(reportDir)/gitleaks.json >> $(artifactHtmlDir)/gitleaks.html
          echo "</ul></body></html>" >> $(artifactHtmlDir)/gitleaks.html
        displayName: "ğŸ–¥ï¸ GÃ©nÃ©rer HTML Gitleaks simplifiÃ©"

      - task: PublishBuildArtifacts@1
        displayName: 'ğŸ“¤ Publier rapports HTML Gitleaks'
        inputs:
          PathtoPublish: '$(artifactHtmlDir)'
          ArtifactName: 'Gitleaks-HTML-Reports'
          publishLocation: 'Container'

      - task: PublishBuildArtifacts@1
        displayName: 'ğŸ“¤ Publier rÃ©sumÃ© Markdown Gitleaks'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'Gitleaks-Summary'
          publishLocation: 'Container'

      - script: |
          echo "ğŸ“ Affichage du rÃ©sumÃ© Markdown dans la page du pipeline"
          echo "##vso[task.addattachment type=Distributedtask.Core.Summary;name=Rapport Gitleaks;]$(summaryFile)"
        displayName: 'Afficher rÃ©sumÃ© dans la page du pipeline'
